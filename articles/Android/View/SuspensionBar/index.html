<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Android沉浸式状态栏、颜色渐变、副标题动画和TabLayout悬浮条 | RiceEater的小小世界 | My Life&#39;s Getting Better.</title>

  
  <meta name="author" content="小米粒">
  

  
  <meta name="description" content="嘛，几天没学习，我浑身难受。
今天把前段时间公司这边的几个需求放在一起总结了一下，有这样几个:

沉浸式状态栏(5.0以上)，并要求上部bar随着RecyclerView滑动变色
RecyclerView悬浮条，与普通悬浮条不同的是悬浮条是一个可滑动的TabLayout
副标题随着RecyclerView滑动动画上移或者动画下移

把这几个东西放一起来重新梳理一下吧，先上效果图：

左边是Android4.1上的效果，右边是5.0以上效果。下面就一点点来分析这种效果是如何实现的。">
  

  
  <meta name="keywords" content="RiceEater 小米粒 riceeater.info">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="Android沉浸式状态栏、颜色渐变、副标题动画和TabLayout悬浮条"/>

  <meta property="og:site_name" content="RiceEater的小小世界"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="RiceEater的小小世界" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 5.1.1"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">RiceEater的小小世界</a>
    </h1>
    <p class="site-description">My Life&#39;s Getting Better.</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives">归档</a></li>
      
        <li><a href="/plans">计划</a></li>
      
        <li><a href="/about">关于</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>Android沉浸式状态栏、颜色渐变、副标题动画和TabLayout悬浮条</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/articles/Android/View/SuspensionBar/" rel="bookmark">
        <time class="entry-date published" datetime="2018-05-15T11:39:40.000Z">
          2018-05-15
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>嘛，几天没学习，我浑身难受。</p>
<p>今天把前段时间公司这边的几个需求放在一起总结了一下，有这样几个:</p>
<ul>
<li><strong>沉浸式状态栏(5.0以上)，并要求上部bar随着RecyclerView滑动变色</strong></li>
<li><strong>RecyclerView悬浮条，与普通悬浮条不同的是悬浮条是一个可滑动的TabLayout</strong></li>
<li><strong>副标题随着RecyclerView滑动动画上移或者动画下移</strong></li>
</ul>
<p>把这几个东西放一起来重新梳理一下吧，先上效果图：</p>
<p><img src="/images/%E8%87%AA%E5%AE%9A%E4%B9%89View-%E6%82%AC%E6%B5%AE%E6%9D%A1.gif"></p>
<p>左边是Android4.1上的效果，右边是5.0以上效果。下面就一点点来分析这种效果是如何实现的。</p>
<a id="more"></a>

<h3 id="副标题动画"><a href="#副标题动画" class="headerlink" title="副标题动画"></a>副标题动画</h3><p>从上面的效果图可以看出，副标题在RecyclerView滑动时会有位移效果，我这里的思路是使用一个FrameLayout重叠放置两个TextView，在Activity初始化后，监听RecyclerView的滑动，并在特定时机执行相应动画。</p>
<p>那么首先布局文件如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">RelativeLayout</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:id</span>=<span class="string">&quot;@+id/rl_title_bar&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">&quot;45dp&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:background</span>=<span class="string">&quot;#0873d2&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:id</span>=<span class="string">&quot;@+id/tv_title&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:layout_centerHorizontal</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:textSize</span>=<span class="string">&quot;16sp&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:textColor</span>=<span class="string">&quot;#ffffff&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:text</span>=<span class="string">&quot;这是重要的标题&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">FrameLayout</span></span></span><br><span class="line"><span class="tag">                 <span class="attr">android:layout_alignParentBottom</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">                 <span class="attr">android:layout_marginBottom</span>=<span class="string">&quot;5dp&quot;</span></span></span><br><span class="line"><span class="tag">                 <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                 <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                 <span class="attr">android:layout_centerHorizontal</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:id</span>=<span class="string">&quot;@+id/tv_sub_title&quot;</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:layout_centerHorizontal</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:textSize</span>=<span class="string">&quot;12sp&quot;</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:textColor</span>=<span class="string">&quot;#e3e3e3&quot;</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:text</span>=<span class="string">&quot;这是不重要的副标题&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:id</span>=<span class="string">&quot;@+id/tv_sub_title2&quot;</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:layout_centerHorizontal</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:textSize</span>=<span class="string">&quot;12sp&quot;</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:textColor</span>=<span class="string">&quot;#e3e3e3&quot;</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:text</span>=<span class="string">&quot;这是更不重要的副标题&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">FrameLayout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在Activity的<code>onCreate</code>方法中，添加RecyclerView监听，并且执行动画：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> animationHeight = <span class="number">60</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 给RecyclerView增加滑动监听</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initListener</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    rvContainer.addOnScrollListener(<span class="keyword">new</span> RecyclerView.OnScrollListener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onScrolled</span><span class="params">(RecyclerView recyclerView, <span class="keyword">int</span> dx, <span class="keyword">int</span> dy)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.onScrolled(recyclerView, dx, dy);</span><br><span class="line">            <span class="keyword">int</span> firstVisible = ((LinearLayoutManager) recyclerView.getLayoutManager()).findFirstVisibleItemPosition();</span><br><span class="line">            <span class="keyword">if</span>(firstVisible &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                View view = linearLayoutManager.findViewByPosition(<span class="number">0</span>);<span class="comment">//获取第一item</span></span><br><span class="line">                <span class="keyword">int</span> verticalOffset = recyclerView.computeVerticalScrollOffset();<span class="comment">//获取第一个item纵向滑动距离</span></span><br><span class="line">                <span class="keyword">float</span> viewHeight = view.getMeasuredHeight() - rlTitleBar.getMeasuredHeight();<span class="comment">//获取滑动距离</span></span><br><span class="line">                <span class="keyword">if</span>(verticalOffset &gt; animationHeight) &#123;</span><br><span class="line">                    startAnimator(<span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    startAnimator(<span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 开始副标题动画</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startAnimator</span><span class="params">(<span class="keyword">int</span> subTitleStatus)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//处理不需要动画的状况</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>.subTitleStatus == subTitleStatus) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.subTitleStatus = subTitleStatus;</span><br><span class="line">    <span class="keyword">if</span>(subTitleStatus == <span class="number">0</span>) &#123;</span><br><span class="line">        ObjectAnimator objectAnimator = ObjectAnimator.ofFloat(tvSubTitle, <span class="string">&quot;y&quot;</span>, (<span class="keyword">float</span>) -tvSubTitle.getMeasuredHeight(),<span class="number">0f</span>);</span><br><span class="line">        ObjectAnimator objectAnimator2 = ObjectAnimator.ofFloat(tvSubTitle2, <span class="string">&quot;y&quot;</span>,<span class="number">0f</span> , (<span class="keyword">float</span>) tvSubTitle2.getMeasuredHeight());</span><br><span class="line">        AnimatorSet animatorSet = <span class="keyword">new</span> AnimatorSet();</span><br><span class="line">        animatorSet.setDuration(<span class="number">500</span>);</span><br><span class="line">        animatorSet.play(objectAnimator).with(objectAnimator2);</span><br><span class="line">        animatorSet.start();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ObjectAnimator objectAnimator = ObjectAnimator.ofFloat(tvSubTitle, <span class="string">&quot;y&quot;</span>, <span class="number">0f</span>, (<span class="keyword">float</span>) -tvSubTitle.getMeasuredHeight());</span><br><span class="line">        ObjectAnimator objectAnimator2 = ObjectAnimator.ofFloat(tvSubTitle2, <span class="string">&quot;y&quot;</span>, (<span class="keyword">float</span>) tvSubTitle2.getMeasuredHeight(),<span class="number">0f</span>);</span><br><span class="line">        AnimatorSet animatorSet = <span class="keyword">new</span> AnimatorSet();</span><br><span class="line">        animatorSet.setDuration(<span class="number">500</span>);</span><br><span class="line">        animatorSet.play(objectAnimator).with(objectAnimator2);</span><br><span class="line">        animatorSet.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码很清晰，使用属性动画模拟副标题的滚动，注意这里需要处理不需要执行动画的情况，不然疯狂重复执行容易导致crash。属性动画的使用可以看我之前的博文<a href="/tags/Android%E5%8A%A8%E7%94%BB/">Android动画</a></p>
<h3 id="沉浸式状态栏"><a href="#沉浸式状态栏" class="headerlink" title="沉浸式状态栏"></a>沉浸式状态栏</h3><p>Android5.0的沉浸式状态栏会更美观一下，我这里没有理会4.4的情况，其实就是因为懒。</p>
<p>咳咳，我们继续。其实要实现沉浸式状态栏，只需要这样就可以了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(Build.VERSION.SDK_INT &gt;= <span class="number">21</span>) &#123;</span><br><span class="line">        <span class="comment">//Android5.0以上，设置状态栏透明并且全屏</span></span><br><span class="line">        View decorView = getWindow().getDecorView();</span><br><span class="line">        <span class="keyword">int</span> option = View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN</span><br><span class="line">            | View.SYSTEM_UI_FLAG_LAYOUT_STABLE;</span><br><span class="line">        decorView.setSystemUiVisibility(option);</span><br><span class="line">        getWindow().setStatusBarColor(Color.TRANSPARENT);</span><br><span class="line">    &#125;</span><br><span class="line">    initTitleBar();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 设置TitleBar状态</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initTitleBar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(Build.VERSION.SDK_INT &gt;= <span class="number">21</span>) &#123;</span><br><span class="line">        <span class="comment">//Android5.0以上，由于状态栏透明了，所以给TitleBar设置一个topPadding，高度为statusBar高度</span></span><br><span class="line">        ViewGroup.LayoutParams params = rlTitleBar.getLayoutParams();</span><br><span class="line">        params.height = params.height + getStatusBarHeight(<span class="keyword">this</span>);</span><br><span class="line">        rlTitleBar.setPadding(<span class="number">0</span>,getStatusBarHeight(<span class="keyword">this</span>),<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据反射获取状态栏高度</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getStatusBarHeight</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> resourceId = context.getResources().getIdentifier(<span class="string">&quot;status_bar_height&quot;</span>, <span class="string">&quot;dimen&quot;</span>,</span><br><span class="line">                                                          <span class="string">&quot;android&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (resourceId &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        result = context.getResources().getDimensionPixelSize(resourceId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码中注释很详细了，这里只需要注意一点，在开启了沉浸式状态栏后，Activity整个View是从屏幕最顶端开始的，因此需要为Titlebar设置一个状态栏高度的padding，否则，感兴趣的朋友可以自己测试看看。</p>
<p>在RecyclerView滑动过程添加监听，不多废话，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">float</span> scrollRatio = <span class="number">0</span>;<span class="comment">//滑动系数,初始设置为0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 给RecyclerView增加滑动监听</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initListener</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    rvContainer.addOnScrollListener(<span class="keyword">new</span> RecyclerView.OnScrollListener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onScrolled</span><span class="params">(RecyclerView recyclerView, <span class="keyword">int</span> dx, <span class="keyword">int</span> dy)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.onScrolled(recyclerView, dx, dy);</span><br><span class="line">            <span class="keyword">int</span> firstVisible = ((LinearLayoutManager) recyclerView.getLayoutManager()).findFirstVisibleItemPosition();</span><br><span class="line">            <span class="keyword">if</span>(firstVisible &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//滑动到第二个item及之后item，将滑动系数设置为1</span></span><br><span class="line">                scrollRatio = <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                View view = linearLayoutManager.findViewByPosition(<span class="number">0</span>);<span class="comment">//获取第一item</span></span><br><span class="line">                <span class="keyword">int</span> verticalOffset = recyclerView.computeVerticalScrollOffset();<span class="comment">//获取第一个item纵向滑动距离</span></span><br><span class="line">                <span class="keyword">float</span> viewHeight = view.getMeasuredHeight() - rlTitleBar.getMeasuredHeight();<span class="comment">//获取滑动距离</span></span><br><span class="line">                scrollRatio = verticalOffset / viewHeight;</span><br><span class="line">            &#125;</span><br><span class="line">            setUpRatio();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里设置了一个滑动系数，记录滑动的百分比，并在之后设置titleBar的透明度：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> startColor = <span class="number">0x600873d2</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> endColor = <span class="number">0xff0873d2</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 为rlTitleBar设置滑动系数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setUpRatio</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(scrollRatio &lt; <span class="number">0</span> || scrollRatio &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">        rlTitleBar.setBackgroundColor(endColor);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> color = (<span class="keyword">int</span>) ArgbHelper.evaluate(scrollRatio,startColor,endColor);</span><br><span class="line">        Log.e(<span class="string">&quot;scrollRatio&quot;</span>,scrollRatio+<span class="string">&quot;   color&quot;</span>+color);</span><br><span class="line">        rlTitleBar.setBackgroundColor(color);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里也没什么好说的，滑动系数为0 或者大余1，设置为不透明，0到1中间，使用ArgbEvaluator来计算颜色值(其实只有Alpha在变化，从0x600873d2到0xff0873d2)，这里之所以不用SDK中的ArgbEvaluator是由于低版本貌似有点问题，具体原因不知道，我这里直接copy了API27的代码。关于Evaluator的知识，见<a href="/articles/Android/Animation/Animator-2/">Android 动画学习之属性动画 (Property Animator)-2、属性动画执行流程</a></p>
<h3 id="TabLayout悬浮"><a href="#TabLayout悬浮" class="headerlink" title="TabLayout悬浮"></a>TabLayout悬浮</h3><p>悬浮其实是一个老生常谈的东西了，我们都知道RecyclerView做悬浮条一般会在Activity中放置一个与RecyclerViewItem中同样的View，然后在滑动监听中显示或者隐藏这个View。这里一个难点在于怎么将RecyclerView中的Tablayout与Activity中TabLayout的滑动点击等等，我这里选择在TabLayout的dispatchTouchEvent传递触摸事件。</p>
<p>先来看看悬浮条的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 给RecyclerView增加滑动监听</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initListener</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    rvContainer.addOnScrollListener(<span class="keyword">new</span> RecyclerView.OnScrollListener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onScrolled</span><span class="params">(RecyclerView recyclerView, <span class="keyword">int</span> dx, <span class="keyword">int</span> dy)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.onScrolled(recyclerView, dx, dy);</span><br><span class="line">            <span class="keyword">int</span> firstVisible = ((LinearLayoutManager) recyclerView.getLayoutManager()).findFirstVisibleItemPosition();</span><br><span class="line">            <span class="keyword">if</span>(firstVisible &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//滑动到第二个item及之后item，将滑动系数设置为1</span></span><br><span class="line">                scrollRatio = <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                View view = linearLayoutManager.findViewByPosition(<span class="number">0</span>);<span class="comment">//获取第一item</span></span><br><span class="line">                <span class="keyword">int</span> verticalOffset = recyclerView.computeVerticalScrollOffset();<span class="comment">//获取第一个item纵向滑动距离</span></span><br><span class="line">                <span class="keyword">float</span> viewHeight = view.getMeasuredHeight() - rlTitleBar.getMeasuredHeight();<span class="comment">//获取滑动距离</span></span><br><span class="line">                scrollRatio = verticalOffset / viewHeight;</span><br><span class="line">            &#125;</span><br><span class="line">            updateSuspension();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 更新悬浮条</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateSuspension</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(scrollRatio &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">//显示悬浮条</span></span><br><span class="line">        tlSuspension.setVisibility(View.VISIBLE);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//隐藏悬浮条</span></span><br><span class="line">        tlSuspension.setVisibility(View.INVISIBLE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里就是一个简单的在TitleBar的alpha值为1时显示悬浮条，其余时间隐藏。主要代码需要来看Adapter中的ViewHolder：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TabViewHolder</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">ViewHolder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@BindView(R.id.tl_item)</span></span><br><span class="line">    BindTabLayout tlItem;</span><br><span class="line">    <span class="meta">@BindView(R.id.tv_notice)</span></span><br><span class="line">    TextView tvNotice;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> TabLayout.OnTabSelectedListener onTabSelectedListener;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TabViewHolder</span><span class="params">(View itemView)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(itemView);</span><br><span class="line">        ButterKnife.bind(<span class="keyword">this</span>,itemView);</span><br><span class="line">        onTabSelectedListener = <span class="keyword">new</span> TabLayout.OnTabSelectedListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTabSelected</span><span class="params">(TabLayout.Tab tab)</span> </span>&#123;</span><br><span class="line">                tvNotice.setText(<span class="string">&quot;选中Tab:&quot;</span>+tab.getText());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTabUnselected</span><span class="params">(TabLayout.Tab tab)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTabReselected</span><span class="params">(TabLayout.Tab tab)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        tlItem.addOnTabSelectedListener(onTabSelectedListener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(TabTouchListener listener)</span> </span>&#123;</span><br><span class="line">        tlItem.setListener(listener);</span><br><span class="line">        listener.setListener(tlItem);</span><br><span class="line"></span><br><span class="line">        tlItem.setTabMode(TabLayout.MODE_SCROLLABLE);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">10</span>;i++) &#123;</span><br><span class="line">            TabLayout.Tab tab = tlItem.newTab().setText(<span class="string">&quot;Tab&quot;</span>+i);</span><br><span class="line">            tlItem.addTab(tab);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里使用的重写的tabLayout，只是用了两个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BindTabLayout</span> <span class="keyword">extends</span> <span class="title">TabLayout</span> <span class="keyword">implements</span> <span class="title">TabTouchListener</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> TabTouchListener bindLisnter;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BindTabLayout</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BindTabLayout</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BindTabLayout</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(bindLisnter != <span class="keyword">null</span>) &#123;</span><br><span class="line">            bindLisnter.dispatchBindEvent(ev);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.dispatchTouchEvent(ev);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchBindEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.dispatchTouchEvent(event);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setListener</span><span class="params">(TabTouchListener listener)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bindLisnter = listener;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TabTouchListener</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dispatchBindEvent</span><span class="params">(MotionEvent event)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setListener</span><span class="params">(TabTouchListener listener)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里主要在dispatchTouchEvent方法中，直接将触摸事件传递给另一个TabLayout。这样Tab选中，滑动等等操作两者都是一致的。之后将两个Tablayout绑定在一起，完成功能。</p>
<p>本篇文章就是这样了，其实要讲的东西没有很多，主要东西都在代码里写出了，所以有兴趣的还是看代码吧。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/riceeater/AndroidSuspensionBarDemo">代码地址</a>，欢迎fork，评论~</p>
<p>enjoy~</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Android知识体系/">Android知识体系</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Android实战/">Android实战</a>
    </span>
    

    </div>

    
  </div>
</article>

  






    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2020 小米粒
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>