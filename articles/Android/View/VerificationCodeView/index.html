<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Android自定义View-仿滴滴自定义验证码输入框 | RiceEater的小小世界 | My Life&#39;s Getting Better.</title>

  
  <meta name="author" content="小米粒">
  

  
  <meta name="description" content="之前公司有过需求，要求做一个类似滴滴打车输入验证码的页面，长这样：

来分析一下这个验证码部分，实现这样一个自定义View，首先，要区分单个验证码选中状态和未选中状态，并且光标悬停在选中的验证码中心，其次， 每次输入文字后需要依次显示在每个单独的验证码容器中，还有诸如自定义验证码选中状态、清空输入验证码等等。受到博文Android 自定义View之带密码模式的正方形验证码输入框的启发，我决定使用继承RelativeLayout的方式来完成这个自定义View。
实现思路笔者这里决定继承RelativeLayout来实现自定义验证码的功能。显示验证码可以使用几个TextView，这里需要将TextView统一管理，所以还需要一个TextView数组。有光标，那自然而然的就想到了EditText，可以使用一个透明背景的EditText。几个验证码可以使用TextView以一定的规则进行排列，通过监听EditText的输入，拦截到输入字符，并将字符传递给TextView数组，并将EditText置为空，同时重设TextView选中状态，移动EditText光标。笔者这里采用给EditText设置paddingLeft的方式来实现光标的移动，当然，需要经过一些计算。OK，大概思路就是这样了，具体的代码我们继续看下面的。">
  

  
  <meta name="keywords" content="RiceEater 小米粒 riceeater.info">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="Android自定义View-仿滴滴自定义验证码输入框"/>

  <meta property="og:site_name" content="RiceEater的小小世界"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="RiceEater的小小世界" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 5.1.1"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">RiceEater的小小世界</a>
    </h1>
    <p class="site-description">My Life&#39;s Getting Better.</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives">归档</a></li>
      
        <li><a href="/plans">计划</a></li>
      
        <li><a href="/about">关于</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>Android自定义View-仿滴滴自定义验证码输入框</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/articles/Android/View/VerificationCodeView/" rel="bookmark">
        <time class="entry-date published" datetime="2018-05-09T11:46:08.000Z">
          2018-05-09
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>之前公司有过需求，要求做一个类似滴滴打车输入验证码的页面，长这样：</p>
<p><img src="/images/%E8%87%AA%E5%AE%9A%E4%B9%89View-%E9%AA%8C%E8%AF%81%E7%A0%81%E4%BB%BF%E6%BB%B4%E6%BB%B4.gif"></p>
<p>来分析一下这个验证码部分，实现这样一个自定义View，首先，要区分单个验证码选中状态和未选中状态，并且光标悬停在选中的验证码中心，其次， 每次输入文字后需要依次显示在每个单独的验证码容器中，还有诸如自定义验证码选中状态、清空输入验证码等等。受到博文<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_33553515/article/details/73344155">Android 自定义View之带密码模式的正方形验证码输入框</a>的启发，我决定使用继承RelativeLayout的方式来完成这个自定义View。</p>
<h3 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h3><p><strong>笔者这里决定继承RelativeLayout来实现自定义验证码的功能。显示验证码可以使用几个TextView，这里需要将TextView统一管理，所以还需要一个TextView数组。有光标，那自然而然的就想到了EditText，可以使用一个透明背景的EditText。几个验证码可以使用TextView以一定的规则进行排列，通过监听EditText的输入，拦截到输入字符，并将字符传递给TextView数组，并将EditText置为空，同时重设TextView选中状态，移动EditText光标。笔者这里采用给EditText设置paddingLeft的方式来实现光标的移动，当然，需要经过一些计算。OK，大概思路就是这样了，具体的代码我们继续看下面的。</strong></p>
<a id="more"></a>

<h3 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h3><p>首先，我们需要一个类来继承RelativeLayout，并且给这个类分配上一些自定义属性，在attrs.xml文件中定义以下属性：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 自定义验证码--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">declare-styleable</span> <span class="attr">name</span>=<span class="string">&quot;VerificationCodeView&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--输入框的数量--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">&quot;vcv_code_number&quot;</span> <span class="attr">format</span>=<span class="string">&quot;integer&quot;</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--单个验证码的宽度--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">&quot;vcv_code_width&quot;</span> <span class="attr">format</span>=<span class="string">&quot;dimension|reference&quot;</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--输入框文字颜色--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">&quot;vcv_code_color&quot;</span> <span class="attr">format</span>=<span class="string">&quot;color|reference&quot;</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--输入框文字大小--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">&quot;vcv_code_size&quot;</span> <span class="attr">format</span>=<span class="string">&quot;dimension|reference&quot;</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--输入框获取焦点时边框--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">&quot;vcv_code_bg_focus&quot;</span> <span class="attr">format</span>=<span class="string">&quot;reference&quot;</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--输入框没有焦点时边框--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">&quot;vcv_code_bg_normal&quot;</span> <span class="attr">format</span>=<span class="string">&quot;reference&quot;</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--是否展示密码样式--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">&quot;vcv_code_input_style&quot;</span> <span class="attr">format</span>=<span class="string">&quot;boolean&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">declare-styleable</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>具体属性都再代码中注释出来了，接着，在Java类中取出这些属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 小米Xylitol</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@email</span> xiaomi987@hotmail.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@desc</span> Android验证码View</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018-05-09 10:25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VerificationCodeView</span> <span class="keyword">extends</span> <span class="title">RelativeLayout</span> </span>&#123;</span><br><span class="line"><span class="comment">//当前验证码View用来展示验证码的TextView数组，数组个数由codeNum决定</span></span><br><span class="line">    <span class="keyword">private</span> TextView[] textViews;</span><br><span class="line">    <span class="comment">//用来输入验证码的EditText输入框，输入框会跟随输入个数移动，显示或者隐藏光标等</span></span><br><span class="line">    <span class="keyword">private</span> WiseEditText editText;</span><br><span class="line">    <span class="comment">//当前验证码View展示验证码个数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> codeNum;</span><br><span class="line">    <span class="comment">//每个TextView的宽度</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> codeWidth;</span><br><span class="line">    <span class="comment">//字体颜色</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> textColor;</span><br><span class="line">    <span class="comment">//字体大小</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> textSize;</span><br><span class="line">    <span class="comment">//每个单独验证码的背景</span></span><br><span class="line">    <span class="keyword">private</span> Drawable textDrawable;</span><br><span class="line">    <span class="comment">//验证码选中时的背景</span></span><br><span class="line">    <span class="keyword">private</span> Drawable textFocusedDrawable;</span><br><span class="line">    <span class="comment">//是否展示密码样式</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> showPassword = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//验证码之间间隔</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> dividerWidth = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//对EditText输入进行监听</span></span><br><span class="line">    <span class="keyword">private</span> TextWatcher watcher;</span><br><span class="line">    <span class="comment">//监听删除键和enter键</span></span><br><span class="line">    <span class="keyword">private</span> OnKeyListener onKeyListener;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当前选中的TextView位置，即光标所在位置</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> currentFocusPosition = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">VerificationCodeView</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(context,<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化View</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</span><br><span class="line">        TypedArray array = context.obtainStyledAttributes(attrs, R.styleable.VerificationCodeView, defStyleAttr, <span class="number">0</span>);</span><br><span class="line">        codeNum = array.getInteger(R.styleable.VerificationCodeView_vcv_code_number, <span class="number">4</span>);</span><br><span class="line">        codeWidth = array.getDimensionPixelSize(R.styleable.VerificationCodeView_vcv_code_width, (<span class="keyword">int</span>) dip2px(<span class="number">50</span>, context));</span><br><span class="line">        textColor = array.getColor(R.styleable.VerificationCodeView_vcv_code_color, getResources().getColor(R.color.text_border_focused));</span><br><span class="line">        textSize = array.getDimensionPixelSize(R.styleable.VerificationCodeView_vcv_code_size, getResources().getDimensionPixelOffset(R.dimen.text_size));</span><br><span class="line">        textDrawable = array.getDrawable(R.styleable.VerificationCodeView_vcv_code_bg_normal);</span><br><span class="line">        textFocusedDrawable = array.getDrawable(R.styleable.VerificationCodeView_vcv_code_bg_focus);</span><br><span class="line">        showPassword = array.getBoolean(R.styleable.VerificationCodeView_vcv_code_input_style, <span class="keyword">false</span>);</span><br><span class="line">        array.recycle();</span><br><span class="line">        <span class="comment">//若未设置选中和未选中状态，设置默认</span></span><br><span class="line">        <span class="keyword">if</span> (textDrawable == <span class="keyword">null</span>) &#123;</span><br><span class="line">            textDrawable = getResources().getDrawable(R.drawable.bg_text_normal);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (textFocusedDrawable == <span class="keyword">null</span>) &#123;</span><br><span class="line">            textFocusedDrawable = getResources().getDrawable(R.drawable.bg_text_focused);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        initView(context);</span><br><span class="line">        initListener();</span><br><span class="line">        resetCursorPosition();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到我们这里依次取出了验证码字数、单个验证码宽度(这里默认是正方形)、字体颜色、字体大小、获取焦点背景、失去焦点背景等，并设置了默认值。最后别忘了调用<code>array.recycler()</code>释放资源。</p>
<p>接下来就是对TextView数组<code>textViews</code>以及<code>editText</code>的初始化工作了，在方法<code>initView</code>中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 初始化各View并加入当前View中</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//初始化TextView数组</span></span><br><span class="line">    textViews = <span class="keyword">new</span> TextView[codeNum];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; codeNum; i++) &#123;</span><br><span class="line">        <span class="comment">//循环加入数组中，设置TextView字体大小和颜色，并将TextView依次加入LinearLayout</span></span><br><span class="line">        TextView textView = <span class="keyword">new</span> TextView(context);</span><br><span class="line">        textView.setGravity(Gravity.CENTER);</span><br><span class="line">        textView.setTextColor(textColor);</span><br><span class="line">        textView.setTextSize(textSize);</span><br><span class="line">        textView.setIncludeFontPadding(<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">if</span>(showPassword) &#123;</span><br><span class="line">            <span class="comment">//数字密码样式，可更改</span></span><br><span class="line">            textView.setInputType(InputType.TYPE_CLASS_NUMBER | InputType.TYPE_NUMBER_VARIATION_PASSWORD);</span><br><span class="line">        &#125;</span><br><span class="line">        textViews[i] = textView;</span><br><span class="line">        <span class="keyword">this</span>.addView(textView);</span><br><span class="line">        RelativeLayout.LayoutParams params = (LayoutParams) textView.getLayoutParams();</span><br><span class="line">        params.addRule(CENTER_VERTICAL);</span><br><span class="line">        params.width = (<span class="keyword">int</span>) codeWidth;</span><br><span class="line">        params.height = (<span class="keyword">int</span>) codeWidth;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//初始化EditText，设置背景色为透明，获取焦点，设置光标颜色，设置输入类型等</span></span><br><span class="line">    editText = <span class="keyword">new</span> WiseEditText(context);</span><br><span class="line">    editText.setBackgroundColor(Color.TRANSPARENT);</span><br><span class="line">    editText.requestFocus();</span><br><span class="line">    editText.setInputType(InputType.TYPE_CLASS_NUMBER);</span><br><span class="line">    setCursorRes(R.drawable.cursor);</span><br><span class="line">    addView(editText, ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.MATCH_PARENT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里做了一个循环，将TextView添加进数组中，并将TextView添加进RelativeLayout中，这里注意将TextView设置为纵向居中。EditText的设置比较简单，将其背景设置为透明，并将传入的光标通过反射设置给EditText，设置其输入类型(我这里偷个懒直接设置了<code>TYPE_CLASS_NUMBER</code>)，最后将EditText加入RelativeLayout中。</p>
<p>这一步完成之后我们可以想象，现在的View是几个TextView和EditText堆叠在一起，下一步我们给它们各自调整位置，实现TextView居中，EditText充满父控件。由于我们需要TextView分散居中，需要获取到当前控件的宽度，那么代码就需要在onMeasure之后来执行，笔者这里选择在onLayout中执行设置的代码，在这之前需要考虑在当前控件是wrap_content时重设其高度：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> heightMode = MeasureSpec.getMode(heightMeasureSpec);</span><br><span class="line">    <span class="keyword">if</span> (heightMode == MeasureSpec.AT_MOST) &#123;</span><br><span class="line">        <span class="comment">//若高度是wrap_content，则设置为50dp</span></span><br><span class="line">        heightMeasureSpec = MeasureSpec.makeMeasureSpec((<span class="keyword">int</span>) dip2px(<span class="number">80</span>, getContext()), MeasureSpec.EXACTLY);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//获取到宽高，可以对TextView进行摆放</span></span><br><span class="line">    layoutTextView();</span><br><span class="line">    <span class="keyword">super</span>.onLayout(changed, l, t, r, b);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * onMeasure后获取到测量的控件宽度，计算出每个Code之间的间隔</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">layoutTextView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//获取控件剩余宽度</span></span><br><span class="line">    <span class="keyword">float</span> availableWidth = getMeasuredWidth() - getPaddingLeft() - getPaddingRight();</span><br><span class="line">    <span class="keyword">if</span> (codeNum &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">//计算每个Code之间的间距</span></span><br><span class="line">        dividerWidth = (availableWidth - codeWidth * codeNum) / (codeNum - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; codeNum; i++) &#123;</span><br><span class="line">            <span class="keyword">float</span> leftMargin = codeWidth * i + dividerWidth * i;</span><br><span class="line">            RelativeLayout.LayoutParams params1 = (RelativeLayout.LayoutParams) textViews[i].getLayoutParams();</span><br><span class="line">            params1.leftMargin = (<span class="keyword">int</span>) leftMargin;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置EditText宽度从第一个Code左侧到最后一个Code右侧，设置高度为Code高度</span></span><br><span class="line">    <span class="comment">//设置EditText为纵向居中</span></span><br><span class="line">    editText.setWidth((<span class="keyword">int</span>) availableWidth);</span><br><span class="line">    editText.setHeight((<span class="keyword">int</span>) codeWidth);</span><br><span class="line">    RelativeLayout.LayoutParams params = (LayoutParams) editText.getLayoutParams();</span><br><span class="line">    params.addRule(CENTER_VERTICAL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的<code>layoutTextView</code>方法就是一个摆放TextView的过程，通过<code>getMeasuredWidth</code>获取当前View的宽度，减去左侧右侧内边距，获得子View可用的宽度。算出各个TextView之间的间距，然后逐个设置左边距即可。</p>
<p>EditText就很简单，设置宽度占满父控件，并且垂直居中即可。</p>
<p>接下来是设置EditText的相关监听：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 监听EditText输入字符，监听键盘删除键</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initListener</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    watcher = <span class="keyword">new</span> TextWatcher() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeTextChanged</span><span class="params">(CharSequence s, <span class="keyword">int</span> start, <span class="keyword">int</span> count, <span class="keyword">int</span> after)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTextChanged</span><span class="params">(CharSequence s, <span class="keyword">int</span> start, <span class="keyword">int</span> before, <span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterTextChanged</span><span class="params">(Editable s)</span> </span>&#123;</span><br><span class="line">            String content = s.toString();</span><br><span class="line">            <span class="keyword">if</span>(!TextUtils.isEmpty(content)) &#123;</span><br><span class="line">                <span class="keyword">if</span>(content.length() == <span class="number">1</span>) &#123;</span><br><span class="line">                    setText(content);</span><br><span class="line">                &#125;</span><br><span class="line">                editText.setText(<span class="string">&quot;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    editText.addTextChangedListener(watcher);</span><br><span class="line"></span><br><span class="line">    onKeyListener = <span class="keyword">new</span> OnKeyListener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onKey</span><span class="params">(View v, <span class="keyword">int</span> keyCode, KeyEvent event)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(keyCode == KeyEvent.KEYCODE_DEL &amp;&amp; event.getAction() == KeyEvent.ACTION_DOWN) &#123;</span><br><span class="line">                deleteCode();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    editText.setSoftKeyListener(onKeyListener);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除键按下</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">deleteCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(currentFocusPosition == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//当前光标位置在0，直接返回</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//当前光标不为0，当前光标位置-1，将当前光标位置TextView置为&quot;&quot;，重设光标位置</span></span><br><span class="line">        currentFocusPosition--;</span><br><span class="line">        textViews[currentFocusPosition].setText(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        resetCursorPosition();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 拦截到EditText输入字符，发送给该方法进行处理</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> s</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setText</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(currentFocusPosition &gt;= codeNum) &#123;</span><br><span class="line">        <span class="comment">//光标已经隐藏，直接返回</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//设置字符给当前光标位置的TextView，光标位置后移，重设光标状态</span></span><br><span class="line">    textViews[currentFocusPosition].setText(s);</span><br><span class="line">    currentFocusPosition++;</span><br><span class="line">    resetCursorPosition();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里由于原生EditText在监听软键盘删除按钮时有一些缺陷，某些情况下会出现监听不到的现象。我使用了一个自定义的EditText，具体代码可以下载代码查看，我这里就不多做赘述。监听到删除按钮被按下后，将当前光标所在位置向前移动一位，将移动后位置的TextView设置为空，并且重设光标和选中状态。</p>
<p>监听EditText变化的思路很简单，内容有变化，则取出内容，设置给TextView，并且移动光标位置，将EditText置为空。注意这里<code>editText.setText(&quot;&quot;)</code>一定要放在非空判断里执行，不然会死循环。在setText方法中与删除逻辑大同小异，先判断光标是否已经隐藏(是否已经全部输入)，若未全部输入，将字符设置给当前光标所在位置的TextView，将光标位置后移，并且重设光标和选中状态。</p>
<p>我们来看下重设光标和选中状态的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 重设EditText的光标位置，以及选中TextView的边框颜色</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">resetCursorPosition</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; codeNum;i++) &#123;</span><br><span class="line">        TextView textView = textViews[i];</span><br><span class="line">        <span class="keyword">if</span>(i == currentFocusPosition) &#123;</span><br><span class="line">            textView.setBackgroundDrawable(textFocusedDrawable);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            textView.setBackgroundDrawable(textDrawable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(codeNum &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(currentFocusPosition &lt; codeNum) &#123;</span><br><span class="line">            <span class="comment">//字数小于总数，设置EditText的leftPadding，造成光标移动的错觉</span></span><br><span class="line">            editText.setCursorVisible(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">float</span> leftPadding = codeWidth / <span class="number">2</span> + currentFocusPosition * codeWidth + currentFocusPosition * dividerWidth;</span><br><span class="line">            editText.setPadding((<span class="keyword">int</span>) leftPadding, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//字数大于总数，隐藏光标</span></span><br><span class="line">            editText.setCursorVisible(<span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单来讲就是遍历数组，将对应的选中TextView设置为选中状态，其他则设置为未选中状态。在验证码字数大于1(这不废话嘛)的情况下，隐藏或者展示光标，并根据间距设置EditText的leftPadding值，逻辑很简单，看代码即可。</p>
<p>到这里我们的整个逻辑就已经实现了。看下效果图</p>
<p><img src="/images/%E8%87%AA%E5%AE%9A%E4%B9%89View-%E9%AA%8C%E8%AF%81%E7%A0%81%E4%BB%BF%E6%BB%B4%E6%BB%B4.gif"></p>
<p>看起来还是蛮像那么回事儿的。</p>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>完成了主体逻辑后，我们给自定义View来添加几个公共方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 暴露公共方法，设置光标颜色</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> drawableRes</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCursorRes</span><span class="params">(<span class="meta">@DrawableRes</span> <span class="keyword">int</span> drawableRes)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        java.lang.reflect.Field f = TextView.class.getDeclaredField(&quot;mCursorDrawableRes&quot;);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        f.set(editText, drawableRes);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取输入的验证码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getContent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    StringBuilder builder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    <span class="keyword">for</span>(TextView tv : textViews) &#123;</span><br><span class="line">        builder.append(tv.getText());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> builder.toString();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断是否验证码输入完毕</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isFinish</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(TextView tv : textViews) &#123;</span><br><span class="line">        <span class="keyword">if</span>(TextUtils.isEmpty(tv.getText())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 清除已输入验证码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(TextView tv : textViews) &#123;</span><br><span class="line">        tv.setText(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    currentFocusPosition = <span class="number">0</span>;</span><br><span class="line">    resetCursorPosition();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在xml中，我们可以这样使用该自定义View：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">com.xylitolz.androidverificationcode.view.VerificationCodeView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/view_verification&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginTop</span>=<span class="string">&quot;20dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;240dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:vcv_code_size</span>=<span class="string">&quot;16sp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:vcv_code_bg_focus</span>=<span class="string">&quot;@drawable/bg_text_focused&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:vcv_code_bg_normal</span>=<span class="string">&quot;@drawable/bg_text_normal&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:vcv_code_color</span>=<span class="string">&quot;@color/text_border_focused&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:vcv_code_number</span>=<span class="string">&quot;4&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:vcv_code_width</span>=<span class="string">&quot;50dp&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>接下来是在Activity中的使用演示：</p>
<p><img src="/images/%E8%87%AA%E5%AE%9A%E4%B9%89View-%E9%AA%8C%E8%AF%81%E7%A0%81%E4%BB%BF%E6%BB%B4%E6%BB%B4.gif"></p>
<p>OK，以上就是本次博客的全部内容了，如果您对本文有任何疑问或者文章有错误或者遗漏，请在评论留言告诉我，不胜感激~</p>
<p>本文代码地址<a target="_blank" rel="noopener" href="https://github.com/riceeater/AndroidVerificationCode">github</a>，欢迎fork~</p>
<p>enjoy~</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Android知识体系/">Android知识体系</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Android实战/">Android实战</a><a href="/tags/自定义View/">自定义View</a>
    </span>
    

    </div>

    
  </div>
</article>

  






    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2020 小米粒
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>